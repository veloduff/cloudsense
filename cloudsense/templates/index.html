<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudSense</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .controls { display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
        .controls-row { display: flex; gap: 15px; align-items: center; }
        .metric-card { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 20px; margin: 10px 0; }
        .metric-value { font-size: 24px; font-weight: bold; color: #333; }
        .metric-label { color: #666; font-size: 14px; }
        .chart-container { height: 300px; margin: 20px 0; }
        .service-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .service-item { background: #f8fafe; padding: 15px; border-radius: 4px; border-left: 4px solid #6366f1; cursor: pointer; transition: background 0.2s; }
        .service-item:hover { background: #f1f5f9; }
        #ebsList .service-item, #ec2List .service-item { cursor: default; }
        #ebsList .service-item:hover, #ec2List .service-item:hover { background: #f8f9fa; }
        .alert { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .alert-danger { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        select, input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        input[type="month"]:disabled { color: transparent; }
        button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }

        .loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>CloudSense</h1>
                <div style="font-size: 14px; color: #666; margin-top: 10px;">
                    <div id="accountInfo">Account: Loading...</div>
                    <div id="dateRange">Date Range: Loading...</div>
                </div>
            </div>
            <div class="controls">
                <div class="controls-row">
                    <select id="timeRange">
                        <option value="7">Last 7 days</option>
                        <option value="14">Last 14 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="current-month" selected>Current Month</option>
                        <option value="previous-month">Previous Month</option>
                        <option value="custom-month">Custom Month</option>
                    </select>
                    <input type="month" id="customMonth" title="Select month" disabled value="">
                    <input type="date" id="specificDate" title="Pick a specific date">
                </div>
                <div class="controls-row">
                    <select id="chartType">
                        <option value="line">Line Chart</option>
                        <option value="bar" selected>Bar Chart</option>
                        <option value="pie">Pie Chart</option>
                    </select>
                    <select id="regionFilter">
                        <option value="all">All Regions</option>
                    </select>
                    <input type="number" id="budgetLimit" placeholder="Budget Limit ($)" min="0" step="0.01">

                </div>
                <div class="controls-row">
                    <div id="cacheStatus" style="font-size: 12px; color: #666;"></div>
                    <button onclick="forceRefresh()" style="font-size: 11px; padding: 4px 8px;">Update Cost Data</button>
                </div>
            </div>
        </div>

        <div id="alerts"></div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="metric-card">
                <div class="metric-value" id="totalCost">$0.00</div>
                <div class="metric-label" id="totalCostLabel">Total Cost</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="dailyAvg">$0.00</div>
                <div class="metric-label">Daily Average</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="projectedCost">$0.00</div>
                <div class="metric-label">Monthly Projection</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="budgetUsed">0%</div>
                <div class="metric-label">Budget Used</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="costChart" width="800" height="300"></canvas>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3>Services by Cost</h3>
            <button onclick="showAllCosts()">Show All Costs</button>
        </div>
        <div id="servicesList" class="service-list"></div>

        <div id="breakdowns" style="display: none; margin-top: 30px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div>
                    <h3 id="ebsHeader">EBS Costs</h3>
                    <div id="ebsList" class="service-list"></div>
                </div>
                <div>
                    <h3 id="ec2Header">EC2 Other Charges</h3>
                    <div id="ec2List" class="service-list"></div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">Loading AWS billing data...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let costChart;
        let currentData = null;
        let selectedService = null;
        const serviceColors = ['#3b82f6', '#8b5cf6', '#06b6d4', '#f59e0b', '#10b981', '#f97316', '#6366f1', '#14b8a6', '#a855f7', '#0ea5e9'];
        const CACHE_DURATION = 60 * 60 * 1000; // 1 hour

        function getCacheKey(url) {
            return 'aws_cost_' + btoa(url).replace(/[^a-zA-Z0-9]/g, '');
        }

        function getCachedData(url) {
            try {
                const key = getCacheKey(url);
                const cached = localStorage.getItem(key);
                if (cached) {
                    const data = JSON.parse(cached);
                    if (Date.now() - data.timestamp < CACHE_DURATION) {
                        return data.response;
                    }
                    localStorage.removeItem(key);
                }
            } catch (e) {}
            return null;
        }

        function setCachedData(url, response) {
            try {
                const key = getCacheKey(url);
                localStorage.setItem(key, JSON.stringify({
                    timestamp: Date.now(),
                    response: response
                }));
            } catch (e) {}
        }

        async function fetchWithCache(url) {
            const cached = getCachedData(url);
            if (cached) {
                updateCacheStatus(url, true);
                return cached;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            setCachedData(url, data);
            updateCacheStatus(url, false);
            return data;
        }

        function updateCacheStatus(url, fromCache) {
            const statusDiv = document.getElementById('cacheStatus');
            
            if (fromCache) {
                // Get the timestamp when cache was created
                const key = getCacheKey(url);
                const cached = localStorage.getItem(key);
                if (cached) {
                    const data = JSON.parse(cached);
                    const cacheTime = new Date(data.timestamp);
                    const dateStr = cacheTime.toISOString().split('T')[0];
                    const timeStr = cacheTime.toLocaleTimeString();
                    statusDiv.textContent = `Cost data updated: ${dateStr} ${timeStr}`;
                    statusDiv.style.color = '#28a745';
                }
            } else {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toLocaleTimeString();
                statusDiv.textContent = `Cost data updated: ${dateStr} ${timeStr}`;
                statusDiv.style.color = '#007bff';
            }
        }

        function clearCache() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('aws_cost_')) {
                    localStorage.removeItem(key);
                }
            });
        }

        async function forceRefresh() {
            clearCache();
            await refreshData();
        }
        
        // Clear cache on page load to ensure new fields are fetched
        clearCache();

        async function fetchBillingData() {
            const timeRange = document.getElementById('timeRange').value;
            const region = document.getElementById('regionFilter').value;
            const specificDate = document.getElementById('specificDate').value;
            
            let url;
            if (specificDate) {
                url = `/api/billing?region=${region}&date=${specificDate}`;
            } else if (isMonthlyView()) {
                let month;
                if (timeRange === 'current-month') {
                    month = 'current';
                } else if (timeRange === 'previous-month') {
                    month = 'previous';
                } else if (timeRange === 'custom-month') {
                    month = document.getElementById('customMonth').value || 'current';
                }
                url = `/api/billing?month=${month}&region=${region}`;
            } else {
                url = `/api/billing?days=${timeRange}&region=${region}`;
            }
            
            try {
                return await fetchWithCache(url);
            } catch (error) {
                console.error('Error fetching billing data:', error);
                return { error: 'Failed to fetch billing data' };
            }
        }

        function isMonthlyView() {
            const timeRange = document.getElementById('timeRange').value;
            return ['current-month', 'previous-month', 'custom-month'].includes(timeRange);
        }

        function getMonthParam() {
            const timeRange = document.getElementById('timeRange').value;
            const now = new Date();
            
            if (timeRange === 'current-month') {
                return null; // API defaults to current month
            } else if (timeRange === 'previous-month') {
                const prevMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                return `${prevMonth.getFullYear()}-${String(prevMonth.getMonth() + 1).padStart(2, '0')}`;
            } else if (timeRange === 'custom-month') {
                return document.getElementById('customMonth').value;
            }
            return null;
        }

        async function loadRegions() {
            try {
                const response = await fetch('/api/regions');
                const regions = await response.json();
                const select = document.getElementById('regionFilter');
                
                regions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading regions:', error);
            }
        }

        function updateMetrics(data) {
            const totalCost = data.totalCost || 0;
            const timeRange = document.getElementById('timeRange').value;
            const specificDate = document.getElementById('specificDate').value;
            
            let days, dailyAvg, projectedCost, totalCostLabel;
            
            if (isMonthlyView()) {
                // Monthly view
                const period = data.period || '';
                totalCostLabel = `Total Cost`;
                days = new Date().getDate(); // Days in current month so far
                dailyAvg = totalCost / days;
                projectedCost = dailyAvg * 30;
            } else if (specificDate) {
                // Single day view
                totalCostLabel = 'Total Cost';
                days = 1;
                dailyAvg = totalCost;
                projectedCost = totalCost * 30;
            } else {
                // Multi-day view
                totalCostLabel = 'Total Cost';
                days = parseInt(timeRange) || 30;
                dailyAvg = totalCost / days;
                projectedCost = dailyAvg * 30;
            }
            
            const budgetLimit = parseFloat(document.getElementById('budgetLimit').value) || 0;
            const budgetUsed = budgetLimit > 0 ? (totalCost / budgetLimit * 100) : 0;

            document.getElementById('totalCost').textContent = `$${totalCost < 1 ? totalCost.toFixed(4) : totalCost.toFixed(2)}`;
            document.getElementById('totalCostLabel').textContent = totalCostLabel;
            document.getElementById('dailyAvg').textContent = `$${dailyAvg < 1 ? dailyAvg.toFixed(4) : dailyAvg.toFixed(2)}`;
            document.getElementById('projectedCost').textContent = `$${projectedCost < 1 ? projectedCost.toFixed(4) : projectedCost.toFixed(2)}`;
            document.getElementById('budgetUsed').textContent = `${budgetUsed.toFixed(1)}%`;

            updateAlerts(budgetUsed, projectedCost, budgetLimit);
        }

        function updateAlerts(budgetUsed, projectedCost, budgetLimit) {
            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = '';

            if (budgetLimit > 0) {
                const totalCost = parseFloat(document.getElementById('totalCost').textContent.replace('$', ''));
                if (budgetUsed > 100) {
                    alertsDiv.innerHTML = `<div class="alert alert-danger">⚠️ Budget exceeded! Actual: $${totalCost.toFixed(2)} vs Budget: $${budgetLimit.toFixed(2)}</div>`;
                } else if (budgetUsed > 80) {
                    alertsDiv.innerHTML = `<div class="alert alert-warning">⚠️ Approaching budget limit (${budgetUsed.toFixed(1)}% used)</div>`;
                }
            }
        }

        async function updateChart(data) {
            const ctx = document.getElementById('costChart').getContext('2d');
            
            if (costChart) {
                costChart.destroy();
            }

            let chartData, chartLabel, dailyServiceBreakdown;
            if (selectedService) {
                const serviceData = await fetchServiceData(selectedService);
                chartData = serviceData.dailyCosts || [];
                chartLabel = `${selectedService} Daily Cost`;
            } else {
                chartData = data.dailyCosts || [];
                chartLabel = isMonthlyView() ? 'Daily Cost Breakdown' : 'Total Daily Cost';
            }
            dailyServiceBreakdown = data.dailyServiceBreakdown;

            const chartType = document.getElementById('chartType').value;
            let chartConfig;

            if (chartType === 'pie' && !selectedService) {
                const services = isMonthlyView() ? (data.services || []) : (data.serviceBreakdown || []);
                chartConfig = {
                    type: 'pie',
                    data: {
                        labels: services.map(s => s.service),
                        datasets: [{
                            data: services.map(s => s.cost),
                            backgroundColor: services.map((s, i) => serviceColors[i % serviceColors.length])
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': $' + context.parsed.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                };
            } else if (chartType === 'bar' && !selectedService && dailyServiceBreakdown) {
                // Stacked bar chart showing all services
                const services = isMonthlyView() ? (data.services || []) : (data.serviceBreakdown || []);
                const allServices = services.map(s => s.service);
                
                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: chartData.map(d => d.date),
                        datasets: allServices.map((service, index) => ({
                            label: service,
                            data: dailyServiceBreakdown[service] || [],
                            backgroundColor: serviceColors[index % serviceColors.length]
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value < 1 ? value.toFixed(4) : value.toFixed(2));
                                    }
                                }
                            }
                        }
                    }
                };
            } else {
                // Line or single service chart
                chartConfig = {
                    type: chartType === 'pie' ? 'line' : chartType,
                    data: {
                        labels: chartData.map(d => d.date),
                        datasets: [{
                            label: chartLabel,
                            data: chartData.map(d => d.cost),
                            borderColor: selectedService ? getServiceColor(selectedService) : '#3b82f6',
                            backgroundColor: chartType === 'bar' ? 
                                (selectedService ? getServiceColor(selectedService) : '#3b82f6') : 
                                (selectedService ? getServiceColor(selectedService) + '20' : 'rgba(59, 130, 246, 0.1)'),
                            tension: chartType === 'line' ? 0.1 : 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + (value < 1 ? value.toFixed(4) : value.toFixed(2));
                                    }
                                }
                            }
                        }
                    }
                };
            }

            costChart = new Chart(ctx, chartConfig);
        }



        async function fetchServiceData(serviceName) {
            try {
                const timeRange = document.getElementById('timeRange').value;
                const specificDate = document.getElementById('specificDate').value;
                
                let url;
                if (specificDate) {
                    url = `/api/service/${encodeURIComponent(serviceName)}?date=${specificDate}`;
                } else if (isMonthlyView()) {
                    let month;
                    if (timeRange === 'current-month') {
                        month = 'current';
                    } else if (timeRange === 'previous-month') {
                        month = 'previous';
                    } else if (timeRange === 'custom-month') {
                        month = document.getElementById('customMonth').value || 'current';
                    }
                    url = `/api/service/${encodeURIComponent(serviceName)}?month=${month}`;
                } else {
                    url = `/api/service/${encodeURIComponent(serviceName)}?days=${timeRange}`;
                }
                
                return await fetchWithCache(url);
            } catch (error) {
                console.error('Error fetching service data:', error);
                return { dailyCosts: [] };
            }
        }



        function updateServicesList(data) {
            const servicesDiv = document.getElementById('servicesList');
            const services = isMonthlyView() ? (data.services || []) : (data.serviceBreakdown || []);
            
            servicesDiv.innerHTML = services.map((service, index) => {
                const color = serviceColors[index % serviceColors.length];
                return `
                    <div class="service-item" onclick="showServiceChart('${service.service}')" style="border-left-color: ${color};">
                        <strong>${service.service}</strong>
                        <div style="font-size: 18px; color: #3b82f6; margin-top: 5px;">$${service.cost < 1 ? service.cost.toFixed(4) : service.cost.toFixed(2)}</div>
                        <div style="font-size: 12px; color: #666;">${((service.cost / data.totalCost) * 100).toFixed(1)}% of total</div>
                    </div>
                `;
            }).join('');
        }

        function showServiceChart(serviceName) {
            selectedService = serviceName;
            if (currentData) {
                updateChart(currentData);
            }
        }

        function getServiceColor(serviceName) {
            if (!currentData) return serviceColors[0];
            const services = isMonthlyView() ? (currentData.services || []) : (currentData.serviceBreakdown || []);
            const index = services.findIndex(s => s.service === serviceName);
            return index >= 0 ? serviceColors[index % serviceColors.length] : serviceColors[0];
        }

        function showAllCosts() {
            selectedService = null;
            if (currentData) {
                updateChart(currentData);
            }
        }

        function updateHeaderInfo(data) {
            console.log('Updating header with data:', data);
            if (data && data.accountId) {
                document.getElementById('accountInfo').textContent = `Account: ${data.accountId}`;
            } else {
                document.getElementById('accountInfo').textContent = 'Account: Unknown';
            }
            if (data && data.dateRange) {
                document.getElementById('dateRange').textContent = `Date Range: ${data.dateRange}`;
            } else {
                document.getElementById('dateRange').textContent = 'Date Range: Unknown';
            }
        }



        async function refreshData() {
            document.getElementById('loading').style.display = 'block';
            
            let data;
            // Always fetch EBS and EC2 breakdowns for both daily and monthly views
            const [billingData, ebsData, ec2Data] = await Promise.all([
                fetchBillingData(),
                fetchEbsBreakdown(),
                fetchEc2Breakdown()
            ]);
            
            // Use the same data for both daily and monthly views
            data = billingData;
            
            if (isMonthlyView()) {
                // For monthly view, convert serviceBreakdown to services format
                data.services = data.serviceBreakdown || [];
            }
            
            // Show breakdowns for both daily and monthly views
            document.getElementById('breakdowns').style.display = 'block';
            updateEbsList(ebsData);
            updateEc2List(ec2Data);
            
            document.getElementById('loading').style.display = 'none';
            
            if (data.error) {
                document.getElementById('alerts').innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                document.getElementById('accountInfo').textContent = 'Account: Error';
                document.getElementById('dateRange').textContent = 'Date Range: Error';
                return;
            }

            currentData = data;
            updateMetrics(data);
            updateChart(data);
            updateServicesList(data);
            updateHeaderInfo(data);

        }

        async function fetchEbsBreakdown() {
            try {
                const specificDate = document.getElementById('specificDate').value;
                let url;
                if (specificDate) {
                    url = `/api/daily-ebs?date=${specificDate}`;
                } else if (isMonthlyView()) {
                    const timeRange = document.getElementById('timeRange').value;
                    let month;
                    if (timeRange === 'current-month') {
                        month = 'current';
                    } else if (timeRange === 'previous-month') {
                        month = 'previous';
                    } else if (timeRange === 'custom-month') {
                        month = document.getElementById('customMonth').value || 'current';
                    }
                    url = `/api/daily-ebs?month=${month}`;
                } else {
                    const timeRange = document.getElementById('timeRange').value;
                    url = `/api/daily-ebs?days=${timeRange}`;
                }
                return await fetchWithCache(url);
            } catch (error) {
                return { breakdown: [] };
            }
        }

        async function fetchEc2Breakdown() {
            try {
                const specificDate = document.getElementById('specificDate').value;
                let url;
                if (specificDate) {
                    url = `/api/daily-ec2?date=${specificDate}`;
                } else if (isMonthlyView()) {
                    const timeRange = document.getElementById('timeRange').value;
                    let month;
                    if (timeRange === 'current-month') {
                        month = 'current';
                    } else if (timeRange === 'previous-month') {
                        month = 'previous';
                    } else if (timeRange === 'custom-month') {
                        month = document.getElementById('customMonth').value || 'current';
                    }
                    url = `/api/daily-ec2?month=${month}`;
                } else {
                    const timeRange = document.getElementById('timeRange').value;
                    url = `/api/daily-ec2?days=${timeRange}`;
                }
                return await fetchWithCache(url);
            } catch (error) {
                return { breakdown: [] };
            }
        }

        function updateEbsList(data) {
            console.log('Updating EBS list with data:', data);
            const ebsDiv = document.getElementById('ebsList');
            const ebsHeader = document.getElementById('ebsHeader');
            const breakdown = data.breakdown || [];
            
            const totalEbs = breakdown.reduce((sum, item) => sum + item.cost, 0);
            ebsHeader.textContent = `EBS Costs: $${totalEbs < 1 ? totalEbs.toFixed(4) : totalEbs.toFixed(2)}`;
            
            if (breakdown.length === 0) {
                ebsDiv.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No EBS costs found</div>';
                return;
            }
            
            ebsDiv.innerHTML = breakdown.map((item, index) => {
                const color = serviceColors[index % serviceColors.length];
                return `
                    <div class="service-item" style="border-left-color: ${color};">
                        <strong>${item.category}</strong>
                        <div style="font-size: 18px; color: #3b82f6; margin-top: 5px;">$${item.cost < 1 ? item.cost.toFixed(4) : item.cost.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }

        function updateEc2List(data) {
            console.log('Updating EC2 list with data:', data);
            const ec2Div = document.getElementById('ec2List');
            const ec2Header = document.getElementById('ec2Header');
            const breakdown = data.breakdown || [];
            
            const totalEc2 = breakdown.reduce((sum, item) => sum + item.cost, 0);
            ec2Header.textContent = `EC2 Other Charges: $${totalEc2 < 1 ? totalEc2.toFixed(4) : totalEc2.toFixed(2)}`;
            
            if (breakdown.length === 0) {
                ec2Div.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No EC2 other costs found</div>';
                return;
            }
            
            ec2Div.innerHTML = breakdown.map((item, index) => {
                const color = serviceColors[index % serviceColors.length];
                return `
                    <div class="service-item" style="border-left-color: ${color};">
                        <strong>${item.category}</strong>
                        <div style="font-size: 18px; color: #3b82f6; margin-top: 5px;">$${item.cost < 1 ? item.cost.toFixed(4) : item.cost.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }



        // Initialize
        document.getElementById('timeRange').addEventListener('change', () => {
            const timeRange = document.getElementById('timeRange').value;
            const customMonth = document.getElementById('customMonth');
            
            // Enable/disable custom month input
            if (timeRange === 'custom-month') {
                customMonth.disabled = false;
                const now = new Date();
                customMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            } else {
                customMonth.disabled = true;
            }
            
            document.getElementById('specificDate').value = '';
            selectedService = null;
            refreshData();
        });
        document.getElementById('budgetLimit').addEventListener('input', () => {
            if (currentData) updateMetrics(currentData);
        });
        document.getElementById('chartType').addEventListener('change', () => {
            if (currentData) updateChart(currentData);
        });

        document.getElementById('specificDate').addEventListener('change', () => {
            if (document.getElementById('specificDate').value) {
                document.getElementById('timeRange').value = '';
            }
            refreshData();
        });
        document.getElementById('customMonth').addEventListener('change', () => {
            if (document.getElementById('timeRange').value === 'custom-month') {
                refreshData();
            }
        });



        // Load initial data
        loadRegions();
        refreshData();
    </script>
</body>
</html>